FROM mcr.microsoft.com/dotnet/sdk:5.0 AS build
WORKDIR /app

# copy csproj and restore as distinct layers
COPY *.sln .
COPY TALightServer/*.csproj ./TALightServer/
COPY TALightObjects/*.csproj ./TALightObjects/
COPY TALightTest/*.csproj ./TALightTest/
COPY TALightBench/*.csproj ./TALightBench/
COPY TALight/*.csproj ./TALight/
RUN dotnet restore

# copy everything else and build app
COPY TALightServer/. ./TALightServer/
COPY TALightObjects/. ./TALightObjects/
COPY TALightTest/. ./TALightTest/
COPY TALightBench/. ./TALightBench/
COPY TALight/. ./TALight/

WORKDIR /app/TALightServer
RUN dotnet publish -c Release -o out

FROM mcr.microsoft.com/dotnet/aspnet:5.0 AS runtime
WORKDIR /app
COPY --from=build /app/TALightServer/out ./

ENV ASPNETCORE_URLS http://*:5000
ENV ASPNETCORE_ENVIRONMENT Production

RUN apt-get update -y && apt-get install python3 -y

VOLUME ['/app/Local']
VOLUME ['/app/Logs']

ENTRYPOINT ["dotnet", "TALightServer.dll"]

